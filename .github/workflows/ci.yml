# 文件名: .github/workflows/ci.yml

name: Python CI/CD # 工作流的名称，在 GitHub Actions 界面显示

on:
  push:
    branches:
      - main
      - feature/flask-factory-pattern # 确保在 push 到此分支时触发
  pull_request:
    branches:
      - main
      - feature/flask-factory-pattern # 确保在针对此分支的 PR 时触发
  workflow_dispatch: # 允许手动触发

jobs:
  build-and-test: # 定义一个名为 'build-and-test' 的作业
    name: Build & Test on Python ${{ matrix.python-version }} # 作业在 UI 上的显示名称
    runs-on: ubuntu-latest # 在最新的 Ubuntu 虚拟机上运行此作业

    strategy:
      matrix:
        python-version: ["3.11", "3.12"] # 我们将在 Python 3.11 和 3.12 上测试

    steps:
    - name: Checkout code # 步骤1: 检出 Git 仓库的代码
      uses: actions/checkout@v4 # 使用 GitHub 官方的 actions/checkout Action 来克隆仓库

    - name: Set up Python ${{ matrix.python-version }} # 步骤2: 设置指定的 Python 环境
      uses: actions/setup-python@v5 # 使用 GitHub 官方的 actions/setup-python Action 来配置 Python
      with:
        python-version: ${{ matrix.python-version }} # 使用矩阵中定义的 Python 版本
        cache: 'poetry' # 启用 Poetry 依赖的缓存，可以加快后续运行速度

    - name: Install Poetry # 步骤3: 安装 Poetry 包管理器
      uses: snok/install-poetry@v1 # **这是最推荐的 Poetry 安装 Action，它应该能正确处理 PATH**
      with:
        version: 1.8.2 # 明确指定一个稳定版本，减少不确定性。你可以根据需要调整此版本。

    - name: Configure Poetry and Verify Installation # **新增：诊断步骤，确保 Poetry 正确配置并可见**
      run: |
        # 配置 Poetry 在项目目录内创建虚拟环境（推荐）
        poetry config virtualenvs.in-project true

        # 诊断信息：检查 Poetry 版本和其在 PATH 中的位置
        echo "--- Verifying Poetry Installation ---"
        poetry --version # 尝试运行 poetry 命令，看是否能找到
        which poetry    # 查看 poetry 命令的完整路径
        echo "Current PATH: $PATH" # 打印当前的 PATH 环境变量
        echo "--- End Verification ---"

    - name: Install dependencies with Poetry # 步骤4: 使用 Poetry 安装项目依赖
      run: poetry install --no-root

    - name: Run pre-commit checks # 步骤5: 运行 .pre-commit-config.yaml 中定义的各种代码质量检查
      run: poetry run pre-commit run --all-files

    - name: Run Pytest tests # 步骤6: 运行 Pytest 单元测试
      run: poetry run pytest
